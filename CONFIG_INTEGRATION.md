# Configuration Integration Guide

This document explains how both applications connect to the shared Supabase configuration file (`config.md`).

## Overview

Both **Galatea-AI-Main** and **v0-Galatea-AI-character-factory** now read configuration from `Galatea-AI-Supabase/config.md` automatically. This ensures all applications use the same Supabase instance and credentials.

## Configuration Source

The configuration is stored in:
```
Galatea-AI-Supabase/config.md
```

This file is automatically generated when you run:
```bash
cd Galatea-AI-Supabase
npm start
```

## How It Works

### 1. Config Parser

Both apps include a config parser at:
- `Galatea-AI-Main/lib/config/supabase-config.ts`
- `v0-Galatea-AI-character-factory/lib/config/supabase-config.ts`

The parser:
- Looks for `config.md` in the Supabase directory
- Extracts all configuration values (URLs, keys, ports)
- Falls back to environment variables if config.md is not found
- Caches the configuration for performance

### 2. Supabase Client Integration

Both apps' Supabase clients now use the config parser:

**Before:**
```typescript
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
```

**After:**
```typescript
import { getSupabaseUrl, getSupabaseAnonKey } from "@/lib/config/supabase-config"

const supabaseUrl = getSupabaseUrl()
const supabaseKey = getSupabaseAnonKey()
```

### 3. Edge Functions Integration

Edge Functions automatically use environment variables set by Supabase, but they're optimized with:
- Shared client utilities (`_shared/supabase-client.ts`)
- Optimized S3 operations with signed URLs
- Database connection pooling
- Better error handling

## Usage

### For Application Developers

No changes needed! The apps automatically read from `config.md`:

```typescript
import { createClient } from "@/utils/supabase/client"

// Automatically uses config.md
const supabase = createClient()
```

### For Edge Function Developers

Use the shared utilities for optimized operations:

```typescript
import { 
  createServiceClient, 
  createUserClient, 
  getAuthenticatedUser,
  StorageHelper,
  DatabaseHelper 
} from '../_shared/supabase-client.ts'

// Database operations
const serviceClient = createServiceClient()
const db = new DatabaseHelper()
await db.ensureTable('companions')

// Storage operations
const { user, userClient } = await getAuthenticatedUser(authHeader)
const storage = new StorageHelper(userClient, user.id)
const url = await storage.getSignedUrl('banners', 'user-123/banner.jpg')
```

## Configuration Values

The `config.md` file contains:

- **Project URL**: Main Supabase API endpoint
- **REST URL**: REST API endpoint
- **GraphQL URL**: GraphQL API endpoint
- **Edge Functions URL**: Edge Functions endpoint
- **Database URL**: PostgreSQL connection string
- **Studio URL**: Supabase Studio dashboard
- **Authentication Keys**: Publishable and Secret keys
- **Storage (S3)**: Access keys, secret keys, region

## Fallback Behavior

If `config.md` is not found, the apps fall back to environment variables:

1. First: Try to read from `config.md`
2. Second: Use `NEXT_PUBLIC_SUPABASE_URL` and related env vars
3. Third: Use default local development values

## Updating Configuration

When Supabase restarts, the configuration is automatically updated:

```bash
cd Galatea-AI-Supabase
npm start  # Updates config.md automatically
```

Both apps will pick up the new configuration on next request (config is cached but can be refreshed).

## Edge Functions Optimization

### Database Operations

- **Connection Pooling**: Shared service client for efficient connections
- **Automatic Table Creation**: Tables are created if they don't exist
- **Error Handling**: Comprehensive error handling with retries

### S3 Storage Operations

- **Signed URLs**: Use signed URLs for private files (1-hour expiration)
- **Public URLs**: Direct public URLs for public buckets
- **Optimized Uploads**: Proper content types and cache control
- **Batch Operations**: Efficient file listing and deletion

### Best Practices

1. **Use Service Client** for admin operations (bypasses RLS)
2. **Use User Client** for user-specific operations (respects RLS)
3. **Use StorageHelper** for all file operations
4. **Use DatabaseHelper** for complex queries with error handling

## Troubleshooting

### Config Not Found

If you see "config.md not found":
1. Ensure `Galatea-AI-Supabase/config.md` exists
2. Check file permissions
3. Verify the relative path is correct

### Environment Variables

If config.md is not available, set these environment variables:

```env
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

### Edge Functions Not Working

1. Check Edge Functions server is running:
   ```bash
   cd Galatea-AI-Supabase
   npm run functions:serve
   ```

2. Verify environment variables are set in Supabase:
   ```bash
   supabase secrets list
   ```

## Summary

✅ Both apps automatically read from `config.md`  
✅ Edge Functions optimized for database and S3 operations  
✅ Fallback to environment variables if config.md not found  
✅ Shared utilities for consistent operations  
✅ Better error handling and connection management  

All applications are now fully integrated with the shared Supabase configuration!

